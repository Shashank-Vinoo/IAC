#!/bin/sh

# Get the current directory name (e.g. task1, task2)
TASK_DIR=$(basename "$PWD")

# Cleanup previous builds
rm -rf obj_dir
rm -f ${TASK_DIR}.vcd

# Find the first SystemVerilog and C++ files in this folder
SV_FILE=$(ls *.sv 2>/dev/null | head -n 1)
CPP_FILE=$(ls *.cpp 2>/dev/null | head -n 1)

# Check if both files exist
if [ -z "$SV_FILE" ] || [ -z "$CPP_FILE" ]; then
  echo "Error: Missing .sv or .cpp file in current directory."
  exit 1
fi

echo "Running Verilator for $SV_FILE and $CPP_FILE..."

# Run Verilator to translate Verilog into C++, including testbench
verilator -Wall --cc --trace "$SV_FILE" --exe "$CPP_FILE"

# Build the C++ project via make automatically generated by Verilator
make -j -C obj_dir/ -f Vcounter.mk Vcounter

# Run the executable simulation file
obj_dir/Vcounter

